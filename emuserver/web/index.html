<!DOCTYPE html>
<html>
  <head>
    <title>GBA Emulator</title>
    <link rel="icon" href="docs/favicon.ico" sizes="16x16 32x32 48x48 64x64" type="image/vnd.microsoft.icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body, html {
        height: 100%;
        background-color: black;
        color: white;
      }
      body { margin: 0; overflow: hidden; }
      body, #box, #top {
        display: flex; align-items: center; justify-content: center; flex-direction: column;
      }
      #box {
        color: #aaa; min-height: 12em; width: 30em; max-width: 90%;
        background-color: #333; border-radius: 0.4em; border: 2px solid #555;
        position: relative; flex-direction: column; transition-duration: 0.2s;
        overflow: auto; font-family: monospace; font-weight: bold; font-size: 16px;
        margin: 5px; text-align: center; padding: 10px;
      }
      #box:hover { border-color: #1AAFFF; color: #ddd }
      #display { width: 100%; height: 100% }
      .logo { width: 130px; height: 130px; filter: drop-shadow(0 0 8px white); }
      #top { margin: 5px; }
      .rom-list-title { margin: 0.5em 0 0.25em; font-size: 18px; color: #ddd; }
      .hint { font-size: 12px; color: #888; margin-bottom: 0.5em; }
      .rom-btn {
        padding: 0.6em 0.4em; margin: 0.25em; width: 20em; max-width: 100%;
        font-family: monospace; font-weight: bold; font-size: 16px;
        background-color: #444; color: #aaa; border-radius: 0.4em; border: 1px solid #555;
        cursor: pointer; transition-duration: 0.2s;
      }
      .rom-btn:hover { background-color: #666; color: #ddd }
    </style>
  </head>

  <body>
    <div id="top">
      <h1>EmulatorJS - GBA</h1>
      <img src="docs/Logo-light.png" alt="Logo" class="logo">
      <br>
    </div>
    <div id="box">
      <div class="rom-list-title">Select a GBA ROM</div>
      <div class="hint">Lists come from <code>/_roms</code>. Or use <code>?rom=relative/path/to/file.gba</code>.</div>
      <div id="rom-list">Loadingâ€¦</div>
    </div>

    <script>
      let enableDebug = true;
      let enableThreads = false;
      let browserMode;

      const urlParams = new URLSearchParams(window.location.search);

      if (parseInt(urlParams.get("threads")) === 1 || urlParams.get("threads") === "true") {
        if (window.SharedArrayBuffer) {
          enableThreads = true;
          console.log("Threads are enabled");
        } else {
          console.warn("Threads are disabled as SharedArrayBuffer is not available.");
          console.log("Threads are disabled");
        }
      } else {
        console.log("Threads are disabled");
      }

      if (urlParams.get("browserMode")) {
        browserMode = urlParams.get("browserMode");
      }

      // If a rom query parameter is present, load immediately; otherwise list from /_roms.
      if (urlParams.get("rom")) {
        const romPath = urlParams.get("rom");
        console.log(`Loading ROM from server: /rom/${romPath}`);
        run(romPath);
      } else {
        listRoms();
      }

      // Fetch list from /_roms and render
      async function listRoms() {
        const container = document.getElementById("rom-list");
        try {
          const r = await fetch("/_roms", { cache: "no-store" });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const arr = await r.json();
          renderList(Array.isArray(arr) ? arr : []);
        } catch (e) {
          console.error("Could not list ROMs:", e);
          container.textContent = "No ROMs found or listing failed.";
        }

        function renderList(files) {
          const c = document.getElementById("rom-list");
          c.innerHTML = "";
          if (!files.length) {
            c.textContent = "No ROMs found.";
            return;
          }
          files.forEach(name => {
            const btn = document.createElement("button");
            btn.className = "rom-btn";
            btn.textContent = name;
            btn.onclick = () => run(name);
            c.appendChild(btn);
          });
        }
      }

      // Run a selected ROM via the server's /rom/<path>
      async function run(relativePath) {
        const url = `/rom/${encodeURI(relativePath)}`;
        const fileName = relativePath.split("/").pop();
        const parts = (fileName || "").split(".");

        // Build display container
        const div = document.createElement("div");
        const sub = document.createElement("div");
        const script = document.createElement("script");

        sub.id = "game";
        div.id = "display";

        const top = document.getElementById("top");
        if (top) top.remove();
        const box = document.getElementById("box");
        if (box) box.remove();

        div.appendChild(sub);
        document.body.appendChild(div);

        // Configure EmulatorJS (GBA only)
        window.EJS_player        = "#game";
        window.EJS_gameName      = parts.slice(0, -1).join(".") || fileName || relativePath;
        window.EJS_biosUrl       = "";
        window.EJS_gameUrl       = url;
        window.EJS_core          = "gba";
        window.EJS_pathtodata    = "https://cdn.emulatorjs.org/latest/data/";
        window.EJS_startOnLoaded = true;
        window.EJS_DEBUG_XX      = enableDebug;
        window.EJS_disableDatabases = true;
        window.EJS_threads       = enableThreads;
        if (browserMode) {
          window.EJS_browserMode = browserMode;
        }

        // Load runtime from CDN
        script.src = "https://cdn.emulatorjs.org/latest/data/loader.js";
        document.body.appendChild(script);
      }
    </script>
  </body>
</html>
